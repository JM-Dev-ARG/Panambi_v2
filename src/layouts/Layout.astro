---
import { ClientRouter } from "astro:transitions";
import "../styles/global.css";

//importacion de imagenes
import icono_metadata from "@/assets/svg/logotipo.svg";
import favicon from "@/assets/svg/logotipo.svg";

//data para schema
import dataSchema from "@/data/seoSchema.json";
import NavbarWeb from "@/components/base-components/navbar/NavbarWeb.astro";
import NavBarMovil from "@/components/base-components/navbar/NavBarMovil.astro";
import Footer from "@/components/base-components/Footer.astro";

interface Props {
  title: string;
  description: string;
  keywords?: string[];
  ogImage?: string;
  // ✅ Nuevas props para SEO personalizado
  ogTitle?: string;
  ogDescription?: string;
  twitterTitle?: string;
  twitterDescription?: string;
  pageSchema?: object; // Schema específico de la página
  pageType?: string; // Tipo de página: "WebPage", "AboutPage", "ContactPage", etc.
}

const {
  title,
  description,
  keywords,
  ogImage,
  ogTitle,
  ogDescription,
  twitterTitle,
  twitterDescription,
  pageSchema,
  pageType = "WebPage",
} = Astro.props;

// URL canónica dinámica por página
const canonicalURL = new URL(Astro.url.pathname, Astro.site).toString();

// Imagen OG dinámica o por defecto
const ogImageURL = ogImage
  ? new URL(ogImage, Astro.site).toString()
  : new URL(icono_metadata.src, Astro.site).toString();

// ✅ Usar valores personalizados o por defecto
const finalOgTitle = ogTitle || title;
const finalOgDescription = ogDescription || description;
const finalTwitterTitle = twitterTitle || ogTitle || title;
const finalTwitterDescription =
  twitterDescription || ogDescription || description;

// Schema base de la organización
const organizationSchema = {
  "@type": "ProfessionalService",
  "@id": `${Astro.site}#organization`,
  name: "Panambi",
  description:
    "Estrategia digital, desarrollo web y contenido visual para profesionales y empresas",
  email: "info@panambi.net",
  url: Astro.site?.toString(),
  logo: {
    "@type": "ImageObject",
    url: dataSchema.logo,
  },
  contactPoint: {
    "@type": "ContactPoint",
    telephone: dataSchema.contactPoint.telephone,
    contactType: "Atención al cliente",
    areaServed: dataSchema.contactPoint.areaServed,
    availableLanguage: dataSchema.contactPoint.availableLanguage,
  },
  sameAs: dataSchema.sameAs,
  address: {
    "@type": "PostalAddress",
    streetAddress: dataSchema.address.streetAddress,
    addressLocality: dataSchema.address.addressLocality,
    addressRegion: dataSchema.address.addressRegion,
    postalCode: dataSchema.address.postalCode,
    addressCountry: dataSchema.address.addressCountry,
  },
};

// Schema de la página web
const webPageSchema = {
  "@type": pageType,
  "@id": canonicalURL,
  url: canonicalURL,
  name: title,
  description: description,
  isPartOf: {
    "@id": `${Astro.site}#website`,
  },
  about: {
    "@id": `${Astro.site}#organization`,
  },
  inLanguage: "es-AR",
};

// ✅ Si hay schema personalizado de la página, conectarlo con la organización
const enrichedPageSchema = pageSchema
  ? {
      ...pageSchema,
      provider: {
        "@id": `${Astro.site}#organization`,
      },
    }
  : null;

// Schema final combinado
const schema = {
  "@context": "https://schema.org",
  "@graph": [
    organizationSchema,
    webPageSchema,
    ...(enrichedPageSchema ? [enrichedPageSchema] : []),
  ],
};
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />

    <!-- Title y Description -->
    <title>{title}</title>
    <meta name="description" content={description} />

    <!-- Canonical URL dinámica -->
    <link rel="canonical" href={canonicalURL} />

    <!-- Keywords -->
    {
      keywords && keywords.length > 0 && (
        <meta name="keywords" content={keywords.join(", ")} />
      )
    }

    <!-- SEO General -->
    <meta
      name="robots"
      content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"
    />
    <meta name="author" content="Panambi" />
    <meta name="language" content="Spanish" />

    <!-- SEO Local -->
    <meta name="geo.region" content="AR" />
    <meta name="geo.placename" content="Buenos Aires" />

    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href={favicon.src} />
    <link rel="apple-touch-icon" href={favicon.src} />

    <!-- Client Router -->
    <ClientRouter />

    <!-- Schema.org markup combinado -->
    <script type="application/ld+json" set:html={JSON.stringify(schema)} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={finalOgTitle} />
    <meta property="og:description" content={finalOgDescription} />
    <meta property="og:image" content={ogImageURL} />
    <meta property="og:locale" content="es_AR" />
    <meta property="og:site_name" content="Panambi" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalURL} />
    <meta name="twitter:title" content={finalTwitterTitle} />
    <meta name="twitter:description" content={finalTwitterDescription} />
    <meta name="twitter:image" content={ogImageURL} />

    <!-- Slot para meta tags o schemas adicionales -->
    <slot name="additional-head" />

    <!-- Google Tag Manager -->

    <script>
      /* @ts-ignore */
      (function (w, d, s, l, i) {
        /* @ts-ignore */
        w[l] = w[l] || [];
        /* @ts-ignore */
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        /* @ts-ignore */
        j.async = true;
        /* @ts-ignore */
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        /* @ts-ignore */
        f.parentNode.insertBefore(j, f);
        /* @ts-ignore */
      })(window, document, "script", "dataLayer", "GTM-MT6WKTKV");
    </script>
    <!-- End Google Tag Manager -->

    <!-- Google Analytics -->
    <script>
      /* @ts-ignore */
      window.dataLayer = window.dataLayer || [];
      /* @ts-ignore */
      function gtag() {
        /* @ts-ignore */
        dataLayer.push(arguments);
      }
      /* @ts-ignore */
      gtag("js", new Date());
      /* @ts-ignore */
      gtag("config", "G-972HSR19NQ");
    </script>
    <!-- End Google Analytics -->
  </head>

  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript
      ><iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-MT6WKTKV"
        height="0"
        width="0"
        style="display:none;visibility:hidden"></iframe></noscript
    >
    <!-- End Google Tag Manager (noscript) -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-972HSR19NQ"
    ></script>

    <NavbarWeb />
    <NavBarMovil />
    <main>
      <slot />
    </main>
    <Footer />
  </body>
</html>

<style>
  :root {
    interpolate-size: allow-keywords;
    scroll-behavior: smooth;
    transition-behavior: allow-discrete;
    overflow-x: hidden;
  }
  body {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    background-color: #f9f9f9;
    font-family: var(--font-base);
  }
</style>

<script>
  import AOS from "aos";
  import "aos/dist/aos.css";
  document.addEventListener("astro:page-load", () => {
    AOS.init({
      once: true,
      duration: 800,
    });
  });
</script>
